rules_version = '2';
service cloud.firestore {
  function loggedInWith(userId) {
    return request.auth != null &&
      request.auth.uid == userId;
  }

  function hasKeys(data, keys) {
    return data.keys().hasOnly(keys) &&
      data.keys().hasAll(keys);
  }

  function hasAffectedKeys(data, keys) {
    return data.diff(resource.data).affectedKeys().hasOnly(keys) &&
      data.diff(resource.data).affectedKeys().hasAny(keys);
  }

  function validateCreateProjectInput(data) {
    return hasKeys(data, ['name']) &&
      (
        // name
        data.name is string &&
        data.name.trim() != "" &&
        data.name.size() <= 30
      );
  }

  function validateUpdateProjectInput(data) {
    return hasAffectedKeys(data, ['name']) &&
    (
      // name
      !data.keys().hasAny(['name']) || (
      data.name is string &&
      data.name.trim() != "" &&
      data.name.size() <= 30)
    );
  }

  function validateCreateSectionInput(data) {
    return hasKeys(data, ['name', 'index']) &&
      (
        // name
        data.name is string &&
        data.name.trim() != "" &&
        data.name.size() <= 255
      ) &&
      (
        // index
        data.index is int &&
        data.index >= 0
      );
  }

  function validateUpdateSectionInput(data) {
    return hasAffectedKeys(data, ['name', 'index']) &&
    (
      // name
      !data.keys().hasAny(['name']) || (
      data.name is string &&
      data.name.trim() != "" &&
      data.name.size() <= 255)
    ) &&
    (
      // index
      !data.keys().hasAny(['index']) || (
      data.index is int &&
      data.index >= 0)
    );
  }

  function validateCreateCounterShardInput(id, data) {
    return ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9"].hasAny([id]) &&
      hasKeys(data, ['count']) &&
      (
        // count
        data.count is int &&
        data.count == 0
      );
  }

  function validateUpdateCounterShardInput(data) {
    return hasKeys(data, ['count']) &&
      (
        // count
        data.count is int
      );
  }

  match /databases/{database}/documents {
    match /users/{userId} {
      match /projects/{projectId} {
        allow list, get: if loggedInWith(userId);
        allow create: if loggedInWith(userId) && validateCreateProjectInput(request.resource.data);
        allow update: if loggedInWith(userId) && validateUpdateProjectInput(request.resource.data);
        allow delete: if loggedInWith(userId);

        match /counters/tasks/shards/{shardId} {
          allow list, get: if loggedInWith(userId)
          allow create: if loggedInWith(userId) && validateCreateCounterShardInput(shardId, request.resource.data);
          allow update: if loggedInWith(userId) && validateUpdateCounterShardInput(request.resource.data);
        }

        match /sections/{sectionId} {
          allow list, get: if loggedInWith(userId);
          allow create: if loggedInWith(userId) && validateCreateSectionInput(request.resource.data);
          allow update: if loggedInWith(userId) && validateUpdateSectionInput(request.resource.data);
          allow delete: if loggedInWith(userId);
        }

        match /tasks/{taskId} {
          allow list, get: if loggedInWith(userId);
          allow create: if loggedInWith(userId) && hasKeys(request.resource.data, ['sectionId', 'index', 'title', 'description', 'completedAt']);
          allow update: if loggedInWith(userId) && hasAffectedKeys(request.resource.data, ['sectionId', 'index', 'title', 'description', 'completedAt']);
          allow delete: if loggedInWith(userId);
        }
      }
    }
  }
}
